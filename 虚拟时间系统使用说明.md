# 虚拟时间系统使用说明

## 概述

虚拟时间系统是为充电桩调度计费系统开发的测试功能，允许管理员设置虚拟时间来测试不同时间段的电价变化和调度策略，并支持自动化测试脚本来模拟用户行为。

## 功能特点

### 1. 虚拟时间控制
- **时间设置**：可以设置任意虚拟时间点
- **时间加速**：支持1x到3600x的时间加速倍率
- **时间暂停/恢复**：可以暂停和恢复虚拟时间流逝
- **实时电价显示**：根据虚拟时间实时显示当前电价和时间段

### 2. 自动化测试脚本
- **测试任务管理**：创建、启用、禁用和删除测试脚本
- **定时任务执行**：在指定虚拟时间点自动执行充电请求
- **预设测试场景**：提供峰谷时段对比和调度策略测试场景

### 3. 电价时段系统
- **峰时**：1.0元/度（10:00-15:00，18:00-21:00）
- **平时**：0.7元/度（7:00-10:00，15:00-18:00，21:00-23:00）
- **谷时**：0.4元/度（23:00-次日7:00）

## 使用步骤

### 第一步：创建测试用户

1. 以管理员身份登录系统
2. 进入"测试脚本"页面
3. 点击"创建测试用户"按钮（如果有的话）
4. 或者在后端运行：`npm run create-test-users`

系统将创建7个测试用户：
- 用户名：testuser1 - testuser7
- 密码：123456
- 邮箱：test1@example.com - test7@example.com

### 第二步：设置虚拟时间

1. 进入管理员面板的"虚拟时间"页面
2. 选择要测试的时间点（如6:00谷时或14:00峰时）
3. 设置时间加速倍率（建议先用60x，即1分钟=1小时）
4. 点击"设置虚拟时间"

### 第三步：创建或启用测试脚本

#### 使用预设场景
1. 在"测试脚本"页面点击"创建默认场景"
2. 系统将创建两个预设场景：
   - **峰谷时段对比测试**：在6点和14点分别安排充电请求
   - **调度策略测试**：测试车辆分配到不同充电桩的策略

#### 自定义测试脚本
1. 点击"新建脚本"
2. 填写脚本名称和描述
3. 添加测试任务：
   - 设置触发时间
   - 选择操作类型（创建/修改/取消充电请求）
   - 指定测试用户ID（如test_user_1）
   - 选择充电模式（快充/慢充）
   - 设置充电量
4. 保存脚本并启用

### 第四步：运行测试

1. 启用所需的测试脚本（点击开关按钮）
2. 设置合适的时间加速倍率
3. 观察测试任务的自动执行
4. 在充电桩管理和排队管理页面观察调度情况
5. 在统计报告中查看收费情况

## 测试场景示例

### 场景1：峰谷时段电价测试

**目标**：对比6点（谷时）和14点（峰时）的充电费用差异

1. 设置虚拟时间为当日6:00
2. 启用"峰谷时段对比测试"脚本
3. 设置时间加速为60x
4. 观察：
   - 6:00充电请求的电价（0.4元/度）
   - 14:00充电请求的电价（1.0元/度）
   - 同样20度电量的费用差异

### 场景2：调度策略测试

**目标**：测试系统如何将车辆分配到不同充电桩

1. 设置虚拟时间为当日8:00
2. 启用"调度策略测试"脚本
3. 观察：
   - 车辆是否按照"完成充电所需时长最短"的策略分配
   - 快充桩A、B的使用情况
   - 排队等待时间的计算

### 场景3：自定义高峰期压力测试

1. 创建新脚本，在18:00-21:00期间每5分钟提交一个充电请求
2. 设置不同的充电量和充电模式
3. 观察系统在高峰期的调度表现和等候区管理

## 注意事项

### 系统限制
- 等候区最大容量：6个车位
- 快充桩：2个（A、B），功率30度/小时
- 慢充桩：3个（C、D、E），功率7度/小时
- 每个充电桩队列长度：2个车位

### 使用建议
1. **时间加速设置**：
   - 初次测试建议使用60x（1分钟=1小时）
   - 观察详细过程可用10x
   - 快速测试可用3600x（1秒=1小时）

2. **测试数据准备**：
   - 确保已创建足够的测试用户
   - 充电量设置建议在10-30度之间
   - 可以混合快充和慢充请求

3. **结果观察**：
   - 在虚拟时间界面监控当前时间段和电价
   - 在充电桩管理页面查看实时调度情况
   - 在用户充电记录中查看详细费用计算

### 故障处理
- 如果测试脚本未按预期执行，检查虚拟时间是否正确设置
- 如果充电费用计算异常，确认虚拟时间服务正常运行
- 测试完成后可点击"重置任务状态"重新运行测试

## API接口说明

### 虚拟时间API
- `GET /api/virtual-time/status` - 获取虚拟时间状态
- `POST /api/virtual-time/set` - 设置虚拟时间
- `POST /api/virtual-time/acceleration` - 设置时间加速倍率
- `POST /api/virtual-time/pause` - 暂停虚拟时间
- `POST /api/virtual-time/resume` - 恢复虚拟时间
- `POST /api/virtual-time/disable` - 关闭虚拟时间模式

### 测试脚本API
- `GET /api/test-script/scripts` - 获取所有测试脚本
- `POST /api/test-script/scripts` - 创建测试脚本
- `PATCH /api/test-script/scripts/:id/toggle` - 启用/禁用脚本
- `DELETE /api/test-script/scripts/:id` - 删除脚本
- `POST /api/test-script/default-scenarios` - 创建默认场景
- `POST /api/test-script/reset-tasks` - 重置任务状态

### 测试用户API
- `POST /api/test-users/create` - 创建测试用户

## 技术架构

### 后端组件
- **VirtualTimeService**：虚拟时间管理服务
- **TestScriptService**：测试脚本执行服务
- **ChargingSystemService**：已集成虚拟时间的充电调度服务

### 前端组件
- **VirtualTimeControl**：虚拟时间控制界面
- **TestScriptManager**：测试脚本管理界面
- **AdminDashboard**：已集成新功能的管理员面板

通过这个虚拟时间系统，您可以高效地测试充电桩系统在不同时间段的表现，验证电价计算和调度策略的正确性，而无需等待真实时间的推移。 